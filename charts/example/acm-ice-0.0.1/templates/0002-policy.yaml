apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
 name: {{ printf "%s-%s" .Values.specialResourceModule.metadata.name .Values.openShiftVersion | replace "." "-" | replace "_" "-" | trunc 63 }}
 annotations:
   policy.open-cluster-management.io/categories: CM Configuration Management
   policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
   policy.open-cluster-management.io/standards: NIST-CSF
spec:
 remediationAction: enforce
 disabled: false
 policy-templates:
   - objectDefinition:
       apiVersion: policy.open-cluster-management.io/v1
       kind: ConfigurationPolicy
       metadata:
         name: {{ printf "%s-%s" .Values.specialResourceModule.metadata.name .Values.openShiftVersion | replace "." "-" | replace "_" "-" | trunc 63 }}
       spec:
         remediationAction: enforce
         severity: low
         namespaceselector:
           exclude:
             - kube-*
           include:
             - '*'
         object-templates:
           - complianceType: mustonlyhave
             objectDefinition:
               apiVersion: machineconfiguration.openshift.io/v1
               kind: MachineConfig
               metadata:
                 labels:
                   machineconfiguration.openshift.io/role: worker
                 name: 10-{{.Values.specialResourceModule.metadata.name}}
               spec:
                 config:
                   ignition:
                    version: 3.2.0
                   storage:
                     files:
                       - contents:
                           source: 'data:text/plain;charset=us-ascii;base64,IyEvYmluL2Jhc2gKc2V0IC1ldQoKQUNUSU9OPSQxOyBzaGlmdApJTUFHRT0kMTsgc2hpZnQKS0VSTkVMPSQxOyBzaGlmdAoKcG9kbWFuIHB1bGwgLS1hdXRoZmlsZSAvdmFyL2xpYi9rdWJlbGV0L2NvbmZpZy5qc29uICR7SU1BR0V9OiR7S0VSTkVMfSAyPiYxCgpsb2FkX2ttb2RzKCkgewogICAgcG9kbWFuIHJ1biAtaSAtLXByaXZpbGVnZWQgLXYgL2xpYi9tb2R1bGVzLyR7S0VSTkVMfS9rZXJuZWwvZHJpdmVycy86L2xpYi9tb2R1bGVzLyR7S0VSTkVMfS9rZXJuZWwvZHJpdmVycy8gJHtJTUFHRX06JHtLRVJORUx9IGxvYWQuc2gKfQp1bmxvYWRfa21vZHMoKSB7CiAgICBwb2RtYW4gcnVuIC1pIC0tcHJpdmlsZWdlZCAtdiAvbGliL21vZHVsZXMvJHtLRVJORUx9L2tlcm5lbC9kcml2ZXJzLzovbGliL21vZHVsZXMvJHtLRVJORUx9L2tlcm5lbC9kcml2ZXJzLyAke0lNQUdFfToke0tFUk5FTH0gdW5sb2FkLnNoCn0KCmNhc2UgIiR7QUNUSU9OfSIgaW4KICAgIGxvYWQpCiAgICAgICAgbG9hZF9rbW9kcwogICAgOzsKICAgIHVubG9hZCkKICAgICAgICB1bmxvYWRfa21vZHMKICAgIDs7CiAgICAqKQogICAgICAgIGVjaG8gIlVua25vd24gY29tbWFuZC4gRXhpdGluZy4iCiAgICAgICAgZWNobyAiVXNhZ2U6IgogICAgICAgIGVjaG8gIiIKICAgICAgICBlY2hvICJsb2FkICAgICAgICBMb2FkIGtlcm5lbCBtb2R1bGUocykiCiAgICAgICAgZWNobyAidW5sb2FkICAgICAgVW5sb2FkIGtlcm5lbCBtb2R1bGUocykiCiAgICAgICAgZXhpdCAxCmVzYWM='
                         filesystem: root
                         mode: 493
                         path: /usr/local/bin/{{.Values.specialResourceModule.metadata.name}}
                   systemd:
                     units:
                     - contents: |
                         [Unit]
                         Description=out-of-tree driver loader
                         # Start after the network is up
                         Wants=network-online.target
                         After=network-online.target
                         # Also after docker.service (no effect on systems without docker)
                         After=docker.service
                         # Before kubelet.service (no effect on systems without kubernetes)
                         Before=kubelet.service
 
                         [Service]
                         Type=oneshot
                         RemainAfterExit=true
                         # Use bash to workaround https://github.com/coreos/rpm-ostree/issues/1936
                         ExecStart=/usr/bin/bash -c "while ! /usr/local/bin/{{.Values.specialResourceModule.metadata.name}} load {{.Values.registry}}/{{.Values.specialResourceModule.metadata.name}}-{{.Values.groupName.driverContainer}} {{.Values.kernelFullVersion}}; do sleep 10; done"
                         ExecStop=/usr/bin/bash -c "/usr/local/bin/{{.Values.specialResourceModule.metadata.name}} unload {{.Values.registry}}/{{.Values.specialResourceModule.metadata.name}}-{{.Values.groupName.driverContainer}} {{.Values.kernelFullVersion}}"
                         StandardOutput=journal+console
 
                         [Install]
                         WantedBy=default.target
                       enabled: true
                       name: "{{.Values.specialResourceModule.metadata.name}}.service"
